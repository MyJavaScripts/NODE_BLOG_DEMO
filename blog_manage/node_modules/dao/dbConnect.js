/**
 * Created by 中再融 on 2016/9/21.
 */
var mysql=require('mysql');

function connectServer(){
    var client=mysql.createConnection({
        host:'120.25.229.193',
        user:'root',
        password:'123456!@#$%^',
        database:'blog_new'
    })
    return client;
}

//遍历博客文章列表
function  selectBlogList(client,pageNo,pageSize,blogType,callback){
    //client为一个mysql连接对象
    var sql = 'select bi.id,bi.blog_name,bi.blog_time,bi.blog_type,bi.blog_context,bi.blog_readnum,bi.blog_discuss,bt.type_name from blog_info bi left join blog_type bt on bi.blog_type = bt.id  where 1=1  ';

    if(/^\d+$/.test(blogType)?blogType:0){
        sql+=' and bi.blog_type='+blogType+' ';
    }
    sql+=' limit '+pageNo+','+pageSize+'';
    client.query(sql,function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

function selectBlogListByPageSize(client,callback){
    //client为一个mysql连接对象
    client.query('select count(*) as total_size from blog_info ',function(err,results,fields){
        if(err) throw err;
        callback(results);
    });
}

//获取博客详情信息 通过id
function  selectBlogById(client,blog_id,callback){
    console.log("blog_id=="+blog_id);
    //client为一个mysql连接对象
    client.query('select id,blog_name,blog_time,blog_type,blog_context,blog_readnum,blog_discuss from blog_info where id= '+blog_id+'',function(err,results,fields){
        if(err) throw err;
        callback(results);
    });
}

//遍历博客类别列表 获取每个类别的博文数量
function  selectBlogTypeCount(client,callback){
    //client为一个mysql连接对象
    client.query('select count(bi.blog_type) as count_num,bt.type_name as type_name,bt.id as type_id  from blog_type bt left join blog_info bi on bt.id = bi.blog_type group by bt.id',function(err,results,fields){
        if(err) throw err;
        callback(results);
    });
}

function insertBlog(client ,blogJson,callback){
    blogJson = JSON.parse(blogJson);
    client.query('insert into blog_main (blog_name,blog_author, blog_time, blog_type_id, blog_context)  value(?,?,?,?,?)', [blogJson["blog_name"],blogJson["blog_author"], blogJson["blog_time"],blogJson["blog_type"],blogJson["blog_context"]], function(err,result){
        if( err ){
            console.log( "error:" + err.message);
            return err;
        }
        callback(err);
    });
}

exports.connect = connectServer;
exports.selectBlogList  = selectBlogList;
exports.selectBlogById = selectBlogById;
exports.selectBlogListByPageSize = selectBlogListByPageSize;
exports.selectBlogTypeCount = selectBlogTypeCount;
exports.insertBlog = insertBlog;

