/**
 * Created by dell on 2017/2/27.
 */

var mysql = require('mysql');

function connectServer(){
    var client = mysql.createConnection({
        host:'120.25.229.193',
        user:'root',
        password:'123456!@#$%^',
        database:'blog_new'
    });

    return client;
}

/*
* 博客类别列表
* */
function  selectBlogTypeList(client,callback){
    //client为一个mysql连接对象
    var sql = ' select bt.id, bt.typename, bt.remark from blog_type as bt ';

    client.query(sql,function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

/*
* 博客文章列表
*
* client 客户端
* pageNo 起始条数
* pageSize 每页显示条数
* blogTypeId 博客类别id
* hotTime 近期最火热的帖子 7天、30天、最新
* searchText 搜索文本
* */
function  selectBlogList(client,pageNo,pageSize,blogTypeId,hotTime,searchText,callback){
    console.log(pageNo,pageSize,blogTypeId,hotTime,searchText);
    //client为一个mysql连接对象
    var sql = 'select bm.id, bm.blog_name, bm.blog_time, bm.blog_author, ' +
        'bm.blog_context, bm.blog_look, bm.blog_comment, bm.blog_zan, ' +
        'bm.blog_reward, bm.blog_type_id, bm.blog_type_name ' +
        'from blog_main as bm ' +
        'where 1=1   ';

    blogTypeId = /^\d+$/.test(blogTypeId)?blogTypeId:0;
    if(blogTypeId!=0){
        sql+=' and bm.blog_type_id='+blogTypeId+' ';
    }

    if(typeof(hotTime) != "undefined"){
        sql+=' and bm.blog_time > '+hotTime+' ';
    }

    if(typeof(searchText) != "undefined"){
        sql+=' and bm.blog_name like "%'+searchText+'%" ';
        sql+=' and bm.blog_context like "%'+searchText+'%" ';
        //sql+=' or bm.blog_type_name like '+'%'+searchText+'%'+' ';
    }


    sql+=' order by bm.blog_time desc ';

    pageNo = /^\d+$/.test(pageNo)?pageNo:0;
    pageSize = /^\d+$/.test(pageSize)?pageSize:4;
    sql+=' limit '+pageNo+','+pageSize+' ';


    client.query(sql,function(err,results,fields){
        if(err) throw err;

        callback(results);
    });
}

/*
* 博文详情
* */
function selectBlogDetails(client,blogId,callback){

    var sql = '  select bm.id,bm.blog_name,bm.blog_time,bm.blog_author,' +
        '   bm.blog_context,bm.blog_look,bm.blog_comment,bm.blog_zan,' +
        '   bm.blog_reward,bm.blog_type_id,bm.blog_type_name ' +
        '   from blog_main as bm ' +
        '   where 1=1  and bm.id = '+blogId+' '


    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    })
}


/*
*博客评论列表_parent_id=0
*
* blogId 博文id
* */
function selectBlogComment(client,blogId,callback){
    var sql = ' select bc1.id as comment_id, bc1.man_email, bc1.man_petname, bc1.man_context, ' +
        ' bc1.comment_time, bc1.blog_id, bc1.parent_id, bc1.bycritic, bc1.bycritic_id ' +
        ' from blog_comment as bc1  left join blog_comment as bc2 ' +
        ' on  bc1.parent_id = bc2.id   ' +
        ' where 1=1 '

    if(blogId!=""){
        sql+=' and bc1.blog_id = '+blogId+' '
    }
    sql+=' order by bc1.comment_time desc ';
    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    })
}

/*
 *博客评论列表_parent_id!=0
 *
 * blogId 博文id
 * */
function selectBlogComment(client,blogId,callback){
    var sql = ' select bc1.id as comment_id, bc1.man_email, bc1.man_petname, bc1.man_context, ' +
        ' bc1.comment_time, bc1.blog_id, bc1.parent_id, bc1.bycritic, bc1.bycritic_id ' +
        ' from blog_comment as bc1  left join blog_comment as bc2 ' +
        ' on  bc1.parent_id = bc2.id  ' +
        ' where 1=1 and bc1.parent_id=0 '

    if(blogId!=""){
        sql+=' and bc1.blog_id = '+blogId+' '
    }
    sql+=' order by bc1.comment_time desc ';
    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    })
}

/*
 *博客评论列表_parent_id!=0
 *
 * blogId 博文id
 * */
function selectBlogCommentSub(client,blogId,callback){
    var sql = ' select bc1.id as comment_id, bc1.man_email, bc1.man_petname, bc1.man_context, ' +
        ' bc1.comment_time, bc1.blog_id, bc1.parent_id, bc1.bycritic, bc1.bycritic_id ' +
        ' from blog_comment as bc1  left join blog_comment as bc2 ' +
        ' on  bc1.parent_id = bc2.id  ' +
        ' where 1=1 and bc1.parent_id!=0 '

    if(blogId!=""){
        sql+=' and bc1.blog_id = '+blogId+' '
    }
    sql+=' order by bc1.comment_time asc ';
    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    })
}


/*
* 增加博文评论
*
* manEmail 评论人邮箱地址
* manPetName 评论人昵称
* manContext 评论内容
* commentTime 评论时间
* blogId 博客id
* commentId 评论父级id,没有默认为0
* */
function insertBlogComment(client,manEmail,manPetName,manContext,commentTime,blogId,commentId,bycritic,bycritic_id,callback){
    var sql = ' insert into blog_comment ' +
        '   (man_email,man_petname,man_context,comment_time,blog_id,parent_id,bycritic,bycritic_id)  ' +
        '    values("'+manEmail+'","'+manPetName+'","'+manContext+'","'+commentTime+'","'+blogId+'","'+commentId+'","'+bycritic+'","'+bycritic_id+'") ';
    client.query(sql, function (err,results,fields) {
        if(err) throw err;
        callback(results.insertId);
    });

    var sqlUpdateBlogCommentNum = 'update blog_main as bm set bm.blog_comment = bm.blog_comment+1 where bm.id="'+blogId+'"';
    client.query(sqlUpdateBlogCommentNum, function (err,results,fields) {
        if(err) throw err;
        callback(results);
    });
}

/*
* 喜欢该博文数+1
*
* blogId 博文id
* */
function updateBlogZanAdd(client,blogId,callback){
    blogId = /^\d+$/.test(blogId)?blogId:0
    if(blogId==0) return;

    var sql=' update blog_main as bm  ' +
        'set bm.blog_zan= bm.blog_zan+1 ' +
        'where 1=1 ';

    sql+=' and bm.id='+blogId+' '

    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    });

}

/*
 * 喜欢该博文数-1
 *
 * blogId 博文id
 * */
function updateBlogZanSub(client,blogId,callback){
    blogId = /^\d+$/.test(blogId)?blogId:0
    if(blogId==0) return;

    var sql=' update blog_main as bm  ' +
        'set bm.blog_zan= bm.blog_zan-1 ' +
        'where 1=1 ';

    sql+=' and bm.id='+blogId+' '

    client.query(sql, function (err,results,fields) {
        if(err) throw err;

        callback(results);
    });

}

/*
* 游客点击访问量+1；
*
* blogId 博客id
* */
function updateBlogLook(client,blogId,callback){
    blogId = /^\d+$/.test(blogId)?blogId:0;
    if(blogId==0)return;

    var sql = 'update blog_main as bm set bm.blog_look = bm.blog_look+1 where bm.id="'+blogId+'"';
    client.query(sql, function (err,results,fields) {
        if(err) throw err;
        callback(results);
    })
}



exports.connect = connectServer;
exports.selectBlogTypeList = selectBlogTypeList;
exports.selectBlogList = selectBlogList;
exports.selectBlogDetails = selectBlogDetails;
exports.selectBlogComment = selectBlogComment;
exports.selectBlogCommentSub = selectBlogCommentSub;
exports.insertBlogComment = insertBlogComment;
exports.updateBlogZanAdd = updateBlogZanAdd;
exports.updateBlogZanSub = updateBlogZanSub;
exports.updateBlogLook = updateBlogLook;
